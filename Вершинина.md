## Создать таблицы и задать связи, заполнить данными для следующих примеров:

### 1. Курсы и студенты
- курсы могут проходить несколько студентов
- студент может проходить нескольких курсах
- курс - название, описание
- студент - имя, фамилия, год поступления

### 2. Фестивали и участники
- в фестивале могут принимать участие несколько людей
- человек может принимать участие в нескольких фестивалях
- фестиваль - название, дата, место
- человек - имя, фамилия, дата рождения

### 3. Агрегаторы и таксисты:
- в агрегаторе может работать много таксистов
- таксист может работать в нескольких агрегаторах
- агрегатор - название, телефон
- таксист - имя, фамилия, телефон, автомобиль

## Для каждого примера сделать вывод связанных сущностей - оба возможных варианта (например для сущностей актеров/фильмы нужно 1: для каждого актера вывести массив их фильмов, 2: для каждого фильма вывести массив их актеров)
- в качестве id нужно использовать uuid
- связанная сущность должна быть представлена в виде массива объектов
- учесть случай когда на строки в левой таблице может не быть ссылок

create extension if not exists "uuid-ossp";

drop table if exists students, kyrs, kyrs_to_student cascade;

create table students
(
	id uuid primary key default uuid_generate_v4(),
	first_name text,
	last_name text,
	year_st int,
);

create table kyrs
(
	id uuid primary key default uuid_generate_v4(),
	title text,
	descriprion text,
);

create table kyrs_to_student
(
	student_id uuid references students,
	kyrs_id uuid references kyrss,
	primary key (student_id, kyrs_id),
);

insert into students(first_name, last_name, year_st)
values  ('Иван', 'Иванов', 2023),
		('Пётр', 'Петров', 2022),
		('Мария', 'Кушкова', 2024),
		('Кирилл', 'Смирнов', 2024);
	
insert into kyrs(title, descriprion)
values  ('Программирование на python', 'самый лучший курс'),
		('Английский язык для чайников', 'только для чайников'),
		('Музыка или картины', 'решаем что лучше здесь и сейчас'),
		('Углублённая математика','самые сложные задачи');
	
insert into kyrs_to_student(student_id, kyrs_id)
values
	((select id from actors where last_name = 'Смирнов'),
	 (select id from kyrs where title = 'Музыка или картины')),
	((select id from actors where last_name = 'Смирнов'),
	 (select id from kyrs where title = 'Углублённая математика')),
	((select id from actors where last_name = 'Кушкова'),
	 (select id from kyrs where title = 'Программирование на python')),
	((select id from actors where last_name = 'Петров'),
	 (select id from kyrs where title = 'Программирование на python')),
	((select id from actors where last_name = 'Петров'),
	 (select id from kyrs where title = 'Углублённая математика'));

select 
	st.id,
	st.first_name,
	st.last_name,
	st.year_st,
	coalesce(jsonb_agg(jsonb_build_object(
	'id', k.id, 'title', k.title, 'descriprion', k.descriprion))
		filter (where k.id is not null), '[]') as kyrs
from students st
left join kyrs_to_student ks on st.id = ks.student_id
left join kyrs k on k.id = ks.kyrs_id
group by st.id;

select 
	k.id,
	k.title,
	k.descriprion,
	coalesce(jsonb_agg(jsonb_build_object(
	'id', st.id, 'firts_name', st.firts_name, 'last_name', st.last_name, st.year_st))
		filter (where st.id is not null), '[]') as students
from kyrs k
left join kyrs_to_student ks on k.id = ks.kyrs_id
left join students st on st.id = ks.students_id
group by k.id;



create EXTENSION if not exists "uuid-ossp";

drop table if exists festival, shows;

create table peoples
(
    id uuid primary key default uuid_generate_v4(),
    first_name text,
    last_name text,
    day_db date,
);

create table festivals
(
    id uuid primary key default uuid_generate_v4(),
    title text,
    date_f date,
    place text,
);

create table people_to_festival
(
	people_id uuid references peoples,
	festival_id uuid references festivals,
	primary key (people_id, festival_id),	
);

insert into festival(title, date_f, place)
values
    ('Рок', '2023.04.03', 'Москва'),
    ('Поп', '2022.11.24', 'Санкт-Петербург'),
    ('Дрил', '2021.01.01', 'Сочи');

insert into people(first_name, last_name, day_db)
values
		('Иван', 'Иванов', '2005.12.12'),
		('Пётр', 'Петров', '2002.10.10'),
		('Мария', 'Кушкова', '2006.11.03'),
		('Кирилл', 'Смирнов', '2012.12.12');
	
insert into people_to_festival(people_id, festival_id)
values
	((select id from peoples where last_name = 'Смирнов'),
	 (select id from festival where title = 'Дрил')),
	((select id from peoples where last_name = 'Смирнов'),
	 (select id from festival where title = 'Поп')),
	((select id from peoples where last_name = 'Кушкова'),
	 (select id from festival where title = 'Дрил')),
	((select id from peoples where last_name = 'Иванов'),
	 (select id from festival where title = 'Дрил')); 
	
select
    p.id,
    p.firts_name,
    p.last_name,
    p.day_db,
    coalesce(jsonb_agg(jsonb_build_object(
    	'id', f.id, 'title', f.title, 'date_f', f.date_f, 'place', f.place))
    		filter(where f.id is not null), '[]') as festival
from peoples p
left join people_to_festival pf on p.id = pf.people_id
left join festival f on f.id = pf.festival_id
group by p.id;

select
    f.id,
    f.title,
    f.date_f,
    f.place,
    coalesce(jsonb_agg(jsonb_build_object(
    	'id', p.id, 'first_name', p.firts_name, 'last_name', p.last_name, 'day_db', p.day_db))
    		filter(where p.id is not null), '[]') as peoples
from festivals f
left join people_to_festival pf on f.id = pf.festival_id
left join peoples p on p.id = pf.people_id
group by f.id;



create EXTENSION if not exists "uuid-ossp";

drop table if exists taxis, agregs;

create table taxis
(
    id uuid primary key default uuid_generate_v4(),
    first_name text,
    last_name text,
    phone_t text,
    car text,
);

create table agregs
(
    id uuid primary key default uuid_generate_v4(),
    title text,
	phone_a text,
);

create table taxi_to_agreg
(
	taxi_id uuid references taxis,
	agreg_id uuid references agregs,
	primary key (taxi_id, agreg_id),	
);

insert into agregs(title, phone_a)
values
    ('ооо зеленглазое такси', '79002345678'),
    ('оао малиновая лада', '79234567887'),
    ('роботакси', '798885674554');

insert into taxis(first_name, last_name, phone_t, car)
values
		('Иван', 'Иванов', '99999999999', 'лада'),
		('Пётр', 'Петров', '95678798778', 'ауди'),
		('Мария', 'Кушкова', '98765432121', 'bmw'),
		('Кирилл', 'Смирнов', '96786543443', 'мини купер');
	
insert into taxi_to_agreg(taxi_id, agreg_id)
values
	((select id from taxis where last_name = 'Смирнов'),
	 (select id from agregs where title = 'ооо зеленглазое такси')),
	((select id from taxis where last_name = 'Смирнов'),
	 (select id from agregs where title = 'оао малиновая лада')),
	((select id from taxis where last_name = 'Кушкова'),
	 (select id from agregs where title = 'оао малиновая лада')),
	((select id from taxis where last_name = 'Петров'),
	 (select id from agregs where title = 'оао малиновая лада'));
	 
	 
select
    t.id,
    t.firts_name,
    t.last_name,
    t.phone_t,
    t.car,
    coalesce(jsonb_agg(jsonb_build_object(
    	'id', a.id, 'title', a.title, 'phone_a', a.phone_a))
    		filter(where a.id is not null), '[]') as agregs		
from taxis t
left join taxi_to_agreg ta on t.id = ta.taxi_id
left join agregs a on a.id = ta.agreg_id
group by t.id;

select
    a.id,
    a.title,
    a.phone_a,
    coalesce(jsonb_agg(jsonb_build_object(
    	'id', t.id, 'first_name', t.firts_name, 'last_name', t.last_name, 'phone_t', t.phone_t, 'car', t.car))
    		filter(where t.id is not null), '[]') as taxis
from agregs a
left join taxi_to_agreg pf on a.id = pf.agreg_id
left join taxis t on t.id = pf.taxi_id
group by a.id;

